module.exports=function(e){var t={};function s(n){if(t[n])return t[n].exports;var r=t[n]={i:n,l:!1,exports:{}};return e[n].call(r.exports,r,r.exports,s),r.l=!0,r.exports}return s.m=e,s.c=t,s.d=function(e,t,n){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(s.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)s.d(n,r,function(t){return e[t]}.bind(null,r));return n},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=24)}([function(e,t){e.exports=flarum.core.compat.app},function(e,t){e.exports=flarum.core.compat["utils/Stream"]},function(e,t){e.exports=flarum.core.compat.extend},function(e,t,s){"use strict";function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,n(e,t)}s.d(t,"a",(function(){return r}))},function(e,t){e.exports=flarum.core.compat["utils/stringToColor"]},function(e,t){e.exports=flarum.core.compat["helpers/avatar"]},function(e,t){e.exports=flarum.core.compat["components/DiscussionPage"]},function(e,t){e.exports=flarum.core.compat["extensions/afrux-forum-widgets-core/common/components/Widget"]},,function(e,t){e.exports=flarum.core.compat["extensions/afrux-forum-widgets-core/common/extend/Widgets"]},function(e,t){e.exports=flarum.core.compat["components/LoadingIndicator"]},function(e,t){e.exports=flarum.core.compat["components/Tooltip"]},function(e,t){e.exports=flarum.core.compat["components/Link"]},function(e,t,s){"use strict";var n=s(9),r=s.n(n),i=s(3),o=s(10),a=s.n(o),u=s(11),c=s.n(u),p=s(5),d=s.n(p),l=s(12),f=s.n(l),b=s(4),h=s.n(b),y=s(1),g=s.n(y),v=s(7),w=s.n(v),O=w.a?function(e){function t(){return e.apply(this,arguments)||this}Object(i.a)(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.users=[],this.loading=!0,this.guests=0},s.oncreate=function(t){var s=this;e.prototype.oncreate.call(this,t),app.pusher.then((function(e){var t=e.channels.presence,n=Object.keys(t.members.members),r=!app.session.user||app.session.user&&!app.session.user.preferences().discloseOnline;0===n.length?(t.bind("pusher:subscription_succeeded",(function(e){Object.keys(e.members).map((function(t){t.includes("Guest")?s.guests++:(e.members[t].id=t,s.pushMember(e.members[t]))})),s.loading=!1,m.redraw()})),r&&(s.guests--,m.redraw())):(n.map((function(e){e.includes("Guest")?s.guests++:(t.members.members[e].id=e,s.pushMember(t.members.members[e]))})),s.loading=!1,r&&(s.guests--,m.redraw())),t.bind("pusher:member_removed",(function(e){"string"!=typeof e.id?s.users.some((function(t,n){if(t.id()==e.id)return s.users.splice(n,1),!0})):s.guests--,m.redraw()})),t.bind("pusher:member_added",(function(e){"string"!=typeof e.id?(e.info.id=e.id,s.pushMember(e.info)):s.guests++,m.redraw()}))}))},s.pushMember=function(e){this.users.push({id:g()(e.id),color:g()("#"+h()(e.displayName)),displayName:g()(e.displayName),avatarUrl:g()(e.avatarUrl),slug:g()(e.slug)})},s.className=function(){return"WebsocketOnlineUsersWidget"},s.icon=function(){return"fas fa-user-friends"},s.title=function(){return app.translator.trans("kyrne-websocket.forum.widget.title")},s.content=function(){if(this.loading)return m(a.a,null);var e=this.users;return m("div",{className:"WebsocketOnlineUsersWidget-users"},m("div",{className:"WebsocketOnlineUsersWidget-users-message"},0===e.length?app.translator.trans("kyrne-websocket.forum.widget.empty"):null),m("div",{className:"WebsocketOnlineUsersWidget-users-list"},e.slice(0,12).map((function(e){return m(f.a,{href:app.route("user",{username:e.slug()}),className:"WebsocketOnlineUsersWidget-users-item"},m(c.a,{text:e.displayName()},d()(e)))})),this.guests>0?m("span",{style:e.length>0?"margin-left: 8px":"",className:"WebsocketOnlineUsersWidget-users-guests"},app.translator.trans("kyrne-websocket.forum.widget.guests",{count:this.guests})):"",e.length>12?m("span",{className:"WebsocketOnlineUsersWidget-users-item WebsocketOnlineUsersWidget-users-item--plus"},m("span",{className:"Avatar"},"+12")):null))},t}(w.a):function(){};t.a=function(e){(new r.a).add({key:"WebsocketOnlineUsersWidget",component:O,isDisabled:!1,placement:"end",position:1}).extend(e,"kyrne-websocket")}},function(e,t){e.exports=flarum.core.compat["components/DiscussionList"]},function(e,t){e.exports=flarum.core.compat["components/ReplyComposer"]},function(e,t){e.exports=flarum.core.compat["components/ReplyPlaceholder"]},function(e,t){e.exports=flarum.core.compat["helpers/username"]},function(e,t){e.exports=flarum.core.compat["components/IndexPage"]},,,,,,function(e,t,s){"use strict";s.r(t);var n=s(2),r=s(0),i=s.n(r),o=s(14),a=s.n(o),u=s(6),c=s.n(u),p=s(18),d=s.n(p),l=s(15),f=s.n(l),b=s(16),h=s.n(b),y=s(5),g=s.n(y),v=s(17),w=s.n(v),O=s(1),x=s.n(O),k=s(4),N=s.n(k),j=s(13);i.a.initializers.add("kyrne-websocket",(function(){var e=new Promise((function(e,t){"connected"!==i.a.socketStatus&&$.getScript("https://cdn.jsdelivr.net/npm/pusher-js@7.0.3/dist/web/pusher.min.js",(function(){if(!i.a.session.user&&i.a.forum.attribute("websocketAuthOnly"))return!1;i.a.forum.attribute("debug")&&(Pusher.logToConsole=!0);var t="1"===i.a.forum.attribute("websocketReverseProxy")?443:i.a.forum.attribute("websocketPort")||2083,s=new Pusher(i.a.forum.attribute("websocketKey"),{authEndpoint:i.a.forum.attribute("apiUrl")+"/websocket/auth",cluster:null,wsHost:i.a.forum.attribute("websocketHost")||window.location.hostname,wsPort:i.a.forum.attribute("websocketPort")||2083,wssPort:t,enableStats:!1,encrypted:i.a.forum.attribute("websocketSecure"),auth:{headers:{"X-CSRF-Token":i.a.session.csrfToken}},enabledTransports:["ws","flash"],disabledTransports:["xhr_polling","xhr_streaming","sockjs"]});return s.connection.bind("state_change",(function(e){return i.a.socketStatus=e.current})),e({channels:{main:s.subscribe("public"),user:i.a.session.user?s.subscribe("private-user"+i.a.session.user.id()):null,presence:s.subscribe("presence-forum")},pusher:s})}))}));i.a.pusher=e,i.a.pushedUpdates=[],Object(n.extend)(a.a.prototype,"oncreate",(function(e){i.a.pusher.then((function(e){var t=e.channels;Object.keys(t).map((function(e){null!==t[e]&&t[e].bind("newPost",(function(e){var t=String(e.discussionId),s=i.a.discussions.getParams();-1===["user.posts","user.discussions"].indexOf(i.a.current.data.routeName)&&(s.q||i.a.current.get("discussion")&&t===i.a.current.get("discussion").id()||-1!==i.a.pushedUpdates.indexOf(t)||i.a.request({method:"GET",url:i.a.forum.attribute("apiUrl")+"/discussions/"+t}).then((function(e){if("ignore"!==e.data.attributes.subscription){if(s.filter&&s.filter.tag){var t=e.data.relationships.tags.data.map((function(e){return e.id})),n=[];s.filter.tag.split(",").forEach((function(e){var t=i.a.store.getBy("tags","slug",e);t&&n.push(t.data.id)}));var r=t.some((function(e){return n.includes(e)}));if(console.log(r),0==r)return}if(i.a.forum.attribute("websocketAutoUpdate"))for(var o=i.a.discussions.getPages().length;o>0;o--)i.a.discussions.refresh(o);else i.a.pushedUpdates.push(e),i.a.current.matches(d.a)&&i.a.setTitleCount(i.a.pushedUpdates.length),m.redraw()}})))}))}))}))})),Object(n.extend)(c.a.prototype,"oncreate",(function(){var e=this;i.a.pusher.then((function(t){var s=t.channels;Object.keys(s).map((function(t){null!==s[t]&&s[t].bind("newPost",(function(t){var s=String(t.discussionId);if(e.discussion&&e.discussion.id()===s&&e.stream){var n=e.discussion.commentCount();i.a.store.find("discussions",e.discussion.id()).then((function(){e.stream.update().then((function(){document.hasFocus()||(i.a.setTitleCount(Math.max(0,e.discussion.commentCount()-n)),$(window).one("focus",(function(){return i.a.setTitleCount(0)}))),m.redraw()}))}))}}))}))}))})),Object(n.extend)(a.a.prototype,"onremove",(function(e){i.a.pusher.then((function(e){var t=e.channels;Object.keys(t).map((function(e){null!==t[e]&&t[e].unbind("newPost")}))}))})),Object(n.extend)(c.a.prototype,"onremove",(function(){i.a.pusher.then((function(e){var t=e.channels;Object.keys(t).map((function(e){null!==t[e]&&t[e].unbind("newPost")}))}))})),i.a.pusher.then((function(e){var t=e.channels;t.user&&t.user.bind("notification",(function(){i.a.session.user.pushAttributes({unreadNotificationCount:i.a.session.user.unreadNotificationCount()+1,newNotificationCount:i.a.session.user.newNotificationCount()+1}),i.a.notifications.clear(),m.redraw();var e=document.querySelector(".MobileTab .item-notifications .unread");e&&(e.innerHTML=i.a.session.user.unreadNotificationCount())}))})),Object(n.extend)(c.a.prototype,"view",(function(e){var t=this;app.pusher.then((function(e){!app.discussions.presence&&t.discussion&&(app.discussions.presence=e.pusher.subscribe("presence-"+t.discussion.id()),app.discussions.presence.bind("pusher:subscription_succeeded",(function(e){t.membersOnline=[],Object.keys(e.members).map((function(s){app.discussions.presence.members.myID!=s&&"string"!=typeof s&&(t.membersOnline.push({id:x()(s),color:x()("#"+N()(e.members[s].displayName)),displayName:x()(e.members[s].displayName),avatarUrl:x()(e.members[s].avatarUrl)}),m.redraw())}))})),app.discussions.presence.bind("pusher:member_removed",(function(e){t.membersOnline.some((function(s,n){if(s.id()==e.id)return t.membersOnline.splice(n,1),m.redraw(),!0}))})),app.discussions.presence.bind("pusher:member_added",(function(e){app.discussions.presence.members.myID!=e.id&&"string"!=typeof e.id&&(t.membersOnline.push({id:x()(e.id),color:x()("#"+N()(e.info.displayName)),displayName:x()(e.info.displayName),avatarUrl:x()(e.info.avatarUrl)}),m.redraw())})))}))})),Object(n.extend)(c.a.prototype,"sidebarItems",(function(e){this.membersOnline&&this.membersOnline.length&&e.add("viewing",m("div",{className:"UsersOnline"},m("legend",{className:"UsersOnline-title"},app.translator.trans("kyrne-websocket.forum.discussion_page.viewing_title")),m("ul",{className:"UsersOnline-list"},this.membersOnline.map((function(e){return m("li",{className:"UsersOnline-item"},g()(e),w()(e))})))),-101)})),Object(n.extend)(c.a.prototype,"oncreate",(function(e){window.matchMedia("only screen and (max-width: 767px)").matches||$(window).on("scroll",(function(e){var t=$(".DiscussionPage-nav").children();$(window).scrollTop()>147?(t.css("position","fixed"),t.addClass("websocket-nav")):(t.css("position","absolute"),t.removeClass("websocket-nav"))}))})),Object(n.extend)(c.a.prototype,"onremove",(function(e){var t=this;app.pusher.then((function(e){app.discussions.presence&&(app.discussions.presence=e.pusher.unsubscribe("presence-"+t.discussion.id()),app.discussions.presence=null)}))})),Object(n.extend)(f.a.prototype,"oninit",(function(){var e=this;!function t(){e.typingTimeout=!0,setTimeout((function(){t()}),18e3)}()})),Object(n.extend)(f.a.prototype,"view",(function(){var e=this;app.session.user&&app.session.user.preferences().discloseOnline&&$(".TextEditor-editor").on("keydown",(function(){e.typingTimeout&&(e.typingTimeout=!1,app.request({method:"POST",url:app.forum.attribute("apiUrl")+"/posts/typing",body:{discussionId:e.attrs.discussion.id()}}))}))})),Object(n.extend)(h.a.prototype,"oninit",(function(){var e=this;this.typers={},setTimeout((function(){app.discussions.presence&&app.discussions.presence.bind("typing",(function(t){e.typers[t.userId]||t.userId==app.discussions.presence.members.myID||(e.typers[t.userId]={id:x()(t.userId),color:x()("#"+N()(t.displayName)),displayName:x()(t.displayName),avatarUrl:x()(t.avatarUrl),time:new Date}),m.redraw()}))}),2e3),function t(){Object.keys(e.typers).map((function(t){e.typers[t].time<new Date(Date.now()-2e4)&&(delete e.typers[t],m.redraw())})),setTimeout((function(){t()}),2e4)}()})),Object(n.extend)(h.a.prototype,"view",(function(e){var t=this;Object.keys(this.typers).length&&e.children.push(m("div",{className:"ReplyPlaceholder-typers"},m("ul",{className:"ReplyPlaceholder-typers-list"},Object.keys(this.typers).map((function(e){return m("li",{className:"ReplyPlaceholder-typers-item"},g()(t.typers[e]),w()(t.typers[e]),m("div",{className:"tiblock"},m("div",{className:"tidot"}),m("div",{className:"tidot"}),m("div",{className:"tidot"})))})))))})),i.a.initializers.has("afrux/forum-widgets-core")&&Object(j.a)(i.a)}))}]);
//# sourceMappingURL=forum.js.map